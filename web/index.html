<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniSub - NFT Subscription Platform</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #5a67d8;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 103, 216, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .collection-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .collection-card:hover {
            border-color: #5a67d8;
            transform: translateY(-3px);
        }

        .collection-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .collection-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5a67d8, #667eea);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .alert-success {
            background: #f0fff4;
            border-color: #48bb78;
            color: #22543d;
        }

        .alert-error {
            background: #fff5f5;
            border-color: #f56565;
            color: #742a2a;
        }

        .alert-info {
            background: #ebf8ff;
            border-color: #4299e1;
            color: #2a4365;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5a67d8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .network-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .balance-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            margin: 10px 0;
        }

        .hidden { display: none !important; }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: white;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .container { padding: 10px; }
            .card { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— UniSub</h1>
            <p>å»ä¸­å¿ƒåŒ– NFT è¨‚é–±å¹³å°æ¸¬è©¦ç•Œé¢</p>
        </div>

        <!-- Network & Connection Status -->
        <div class="network-info" id="networkInfo">
            <span id="networkStatus">ğŸ”´ è«‹é€£æ¥éŒ¢åŒ…</span>
        </div>

        <!-- Status Section -->
        <div class="status-section">
            <!-- Wallet Connection -->
            <div class="card">
                <h3>ğŸ”— éŒ¢åŒ…é€£æ¥</h3>
                <div class="balance-display">
                    <div><strong>åœ°å€:</strong> <span id="walletAddress">æœªé€£æ¥</span></div>
                    <div><strong>ETH é¤˜é¡:</strong> <span id="ethBalance">0</span></div>
                    <div><strong>USDT é¤˜é¡:</strong> <span id="usdtBalance">0</span></div>
                </div>
                <button class="btn" id="connectWallet">é€£æ¥ MetaMask</button>
                <button class="btn btn-success" id="faucetBtn" disabled>é ˜å–æ¸¬è©¦ USDT</button>
            </div>

            <!-- Contract Info -->
            <div class="card">
                <h3>ğŸ“‹ åˆç´„è³‡è¨Š</h3>
                <div class="input-group">
                    <label>USDT åˆç´„åœ°å€:</label>
                    <input type="text" id="usdtAddress" placeholder="è«‹è¼¸å…¥ USDT åˆç´„åœ°å€">
                </div>
                <div class="input-group">
                    <label>Factory åˆç´„åœ°å€:</label>
                    <input type="text" id="factoryAddress" placeholder="è«‹è¼¸å…¥ Factory åˆç´„åœ°å€">
                </div>
                <button class="btn btn-warning" id="loadContracts">è¼‰å…¥åˆç´„</button>
            </div>
        </div>

        <!-- Collections Display -->
        <div class="card">
            <h3>ğŸ¬ å¯ç”¨è¨‚é–±æœå‹™</h3>
            <button class="btn" id="loadCollections" disabled>è¼‰å…¥æœå‹™åˆ—è¡¨</button>
            <div id="collectionsContainer" class="collections-grid"></div>
        </div>

        <!-- User Subscriptions -->
        <div class="card">
            <h3>ğŸ“Š æˆ‘çš„è¨‚é–±</h3>
            <button class="btn" id="loadMySubscriptions" disabled>è¼‰å…¥æˆ‘çš„è¨‚é–±</button>
            <div id="subscriptionsContainer"></div>
        </div>

        <!-- Create New Collection (Service Provider) -->
        <div class="card">
            <h3>ğŸ­ å‰µå»ºæ–°æœå‹™ (æœå‹™æä¾›å•†)</h3>
            <div class="input-group">
                <label>æœå‹™åç¨±:</label>
                <input type="text" id="newServiceName" placeholder="ä¾‹: Discord Premium">
            </div>
            <div class="input-group">
                <label>ä»£å¹£ç¬¦è™Ÿ:</label>
                <input type="text" id="newServiceSymbol" placeholder="ä¾‹: DISC">
            </div>
            <div class="input-group">
                <label>åƒ¹æ ¼ (USDT):</label>
                <input type="number" id="newServicePrice" placeholder="ä¾‹: 5" step="0.01">
            </div>
            <div class="input-group">
                <label>è¨‚é–±æœŸé–“ (å¤©):</label>
                <input type="number" id="newServiceDuration" placeholder="ä¾‹: 30" min="1">
            </div>
            <button class="btn btn-success" id="createCollection" disabled>å‰µå»ºæœå‹™</button>
        </div>

        <!-- Messages -->
        <div id="messagesContainer"></div>

        <div class="footer">
            <p>ğŸ”— UniSub - Blockchain Subscription Platform | Built with â¤ï¸</p>
        </div>
    </div>

    <script>
        // Global variables
        let provider, signer, userAddress;
        let usdtContract, factoryContract;
        let isConnected = false;

        // Contract ABIs (simplified)
        const USDT_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function faucet(address to) external",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const FACTORY_ABI = [
            "function getAllCollections() view returns (address[])",
            "function getCollectionInfo(address collection) view returns (tuple(string name, string symbol, address owner, uint256 price, uint256 duration, uint256 createdAt, bool isActive))",
            "function createSubscriptionCollection(string name, string symbol, uint256 price, uint256 duration) external returns (address)",
            "function getMySubscriptions(address user) view returns (address[] collections, uint256[][] tokenIds, uint256[][] expiryTimes)",
            "function hasAnyValidSubscription(address user) view returns (bool hasSubscription, address[] collectionsWithSubscription)"
        ];

        const SUBSCRIPTION_ABI = [
            "function mintSubscription() external",
            "function hasValidSubscription(address user) view returns (bool)",
            "function getUserValidSubscriptions(address user) view returns (uint256[] tokenIds, uint256[] expiryTimes)",
            "function renewSubscription(uint256 tokenId) external",
            "function price() view returns (uint256)",
            "function duration() view returns (uint256)",
            "function name() view returns (string)",
            "function symbol() view returns (string)"
        ];

        // Utility functions
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messagesContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                container.removeChild(alertDiv);
            }, 5000);
        }

        function formatEther(value) {
            return ethers.utils.formatEther(value);
        }

        function formatUSDT(value) {
            return ethers.utils.formatUnits(value, 6);
        }

        function parseUSDT(value) {
            return ethers.utils.parseUnits(value.toString(), 6);
        }

        // Wallet connection
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    document.getElementById('walletAddress').textContent = 
                        userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                    
                    await updateBalances();
                    await updateNetworkInfo();
                    
                    isConnected = true;
                    document.getElementById('connectWallet').textContent = 'âœ… å·²é€£æ¥';
                    document.getElementById('faucetBtn').disabled = false;
                    
                    showMessage('éŒ¢åŒ…é€£æ¥æˆåŠŸ!', 'success');
                } else {
                    showMessage('è«‹å®‰è£ MetaMask!', 'error');
                }
            } catch (error) {
                showMessage('é€£æ¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function updateBalances() {
            if (!isConnected) return;
            
            try {
                const ethBalance = await provider.getBalance(userAddress);
                document.getElementById('ethBalance').textContent = 
                    parseFloat(formatEther(ethBalance)).toFixed(4) + ' ETH';
                
                if (usdtContract) {
                    const usdtBalance = await usdtContract.balanceOf(userAddress);
                    document.getElementById('usdtBalance').textContent = 
                        formatUSDT(usdtBalance) + ' USDT';
                }
            } catch (error) {
                console.error('æ›´æ–°é¤˜é¡å¤±æ•—:', error);
            }
        }

        async function updateNetworkInfo() {
            if (!provider) return;
            
            try {
                const network = await provider.getNetwork();
                const networkNames = {
                    1: 'Ethereum Mainnet',
                    11155111: 'Sepolia Testnet',
                    80001: 'Mumbai Testnet',
                    80002: 'Amoy Testnet',
                    1337: 'Localhost'
                };
                
                const networkName = networkNames[network.chainId] || `Chain ID: ${network.chainId}`;
                document.getElementById('networkStatus').innerHTML = 
                    `ğŸŸ¢ ${networkName}`;
                    
                if (network.chainId === 1) {
                    showMessage('âš ï¸ æ‚¨åœ¨ä¸»ç¶²ä¸Šï¼Œè«‹åˆ‡æ›åˆ°æ¸¬è©¦ç¶²!', 'error');
                }
            } catch (error) {
                console.error('ç²å–ç¶²çµ¡è³‡è¨Šå¤±æ•—:', error);
            }
        }

        // Contract interactions
        async function loadContracts() {
            try {
                const usdtAddress = document.getElementById('usdtAddress').value;
                const factoryAddress = document.getElementById('factoryAddress').value;
                
                if (!usdtAddress || !factoryAddress) {
                    showMessage('è«‹è¼¸å…¥åˆç´„åœ°å€!', 'error');
                    return;
                }
                
                usdtContract = new ethers.Contract(usdtAddress, USDT_ABI, signer);
                factoryContract = new ethers.Contract(factoryAddress, FACTORY_ABI, signer);
                
                await updateBalances();
                
                // Enable buttons
                document.getElementById('loadCollections').disabled = false;
                document.getElementById('loadMySubscriptions').disabled = false;
                document.getElementById('createCollection').disabled = false;
                
                showMessage('åˆç´„è¼‰å…¥æˆåŠŸ!', 'success');
            } catch (error) {
                showMessage('è¼‰å…¥åˆç´„å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function getFaucet() {
            try {
                if (!usdtContract) {
                    showMessage('è«‹å…ˆè¼‰å…¥åˆç´„!', 'error');
                    return;
                }
                
                document.getElementById('faucetBtn').innerHTML = 
                    '<div class="loading"></div>é ˜å–ä¸­...';
                
                const tx = await usdtContract.faucet(userAddress);
                await tx.wait();
                
                await updateBalances();
                showMessage('æˆåŠŸé ˜å– 1000 USDT!', 'success');
                
                document.getElementById('faucetBtn').innerHTML = 'é ˜å–æ¸¬è©¦ USDT';
            } catch (error) {
                showMessage('é ˜å–å¤±æ•—: ' + error.message, 'error');
                document.getElementById('faucetBtn').innerHTML = 'é ˜å–æ¸¬è©¦ USDT';
            }
        }

        async function loadCollections() {
            try {
                const collections = await factoryContract.getAllCollections();
                const container = document.getElementById('collectionsContainer');
                container.innerHTML = '';
                
                if (collections.length === 0) {
                    container.innerHTML = '<p>æš«ç„¡å¯ç”¨æœå‹™</p>';
                    return;
                }
                
                for (const collectionAddress of collections) {
                    const info = await factoryContract.getCollectionInfo(collectionAddress);
                    const subscriptionContract = new ethers.Contract(collectionAddress, SUBSCRIPTION_ABI, signer);
                    
                    const hasSubscription = await subscriptionContract.hasValidSubscription(userAddress);
                    
                    const card = document.createElement('div');
                    card.className = 'collection-card';
                    card.innerHTML = `
                        <div class="collection-header">
                            <div class="collection-icon">${info.symbol.slice(0, 2)}</div>
                            <div>
                                <h4>${info.name}</h4>
                                <small>${collectionAddress.slice(0, 10)}...</small>
                            </div>
                        </div>
                        <div><strong>åƒ¹æ ¼:</strong> ${formatUSDT(info.price)} USDT</div>
                        <div><strong>æœŸé–“:</strong> ${info.duration / (24 * 60 * 60)} å¤©</div>
                        <div><strong>ç‹€æ…‹:</strong> ${hasSubscription ? 'âœ… å·²è¨‚é–±' : 'â­• æœªè¨‚é–±'}</div>
                        <button class="btn ${hasSubscription ? 'btn-warning' : 'btn-success'}" 
                                onclick="subscribeToService('${collectionAddress}', '${formatUSDT(info.price)}', '${info.name}', ${hasSubscription})">
                            ${hasSubscription ? 'çºŒè²»' : 'è¨‚é–±'}
                        </button>
                    `;
                    container.appendChild(card);
                }
            } catch (error) {
                showMessage('è¼‰å…¥æœå‹™å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function subscribeToService(collectionAddress, price, name, isRenewal = false) {
            try {
                const subscriptionContract = new ethers.Contract(collectionAddress, SUBSCRIPTION_ABI, signer);
                const priceWei = parseUSDT(price);
                
                showMessage(`æ­£åœ¨${isRenewal ? 'çºŒè²»' : 'è¨‚é–±'} ${name}...`, 'info');
                
                // Check allowance
                const allowance = await usdtContract.allowance(userAddress, collectionAddress);
                if (allowance.lt(priceWei)) {
                    showMessage('æ­£åœ¨æˆæ¬Š USDT...', 'info');
                    const approveTx = await usdtContract.approve(collectionAddress, priceWei);
                    await approveTx.wait();
                }
                
                // Subscribe
                const tx = await subscriptionContract.mintSubscription();
                await tx.wait();
                
                await updateBalances();
                await loadCollections();
                
                showMessage(`${name} ${isRenewal ? 'çºŒè²»' : 'è¨‚é–±'}æˆåŠŸ!`, 'success');
            } catch (error) {
                showMessage(`${isRenewal ? 'çºŒè²»' : 'è¨‚é–±'}å¤±æ•—: ` + error.message, 'error');
            }
        }

        async function loadMySubscriptions() {
            try {
                const result = await factoryContract.getMySubscriptions(userAddress);
                const [collections, tokenIds, expiryTimes] = result;
                const container = document.getElementById('subscriptionsContainer');
                container.innerHTML = '';
                
                if (collections.length === 0) {
                    container.innerHTML = '<p>æ‚¨é‚„æ²’æœ‰ä»»ä½•è¨‚é–±</p>';
                    return;
                }
                
                for (let i = 0; i < collections.length; i++) {
                    const info = await factoryContract.getCollectionInfo(collections[i]);
                    const subscriptionContract = new ethers.Contract(collections[i], SUBSCRIPTION_ABI, signer);
                    
                    const card = document.createElement('div');
                    card.className = 'collection-card';
                    
                    let tokensHtml = '';
                    for (let j = 0; j < tokenIds[i].length; j++) {
                        const expiry = new Date(expiryTimes[i][j] * 1000);
                        const isExpired = Date.now() > expiry.getTime();
                        tokensHtml += `
                            <div>
                                Token #${tokenIds[i][j]}: 
                                ${isExpired ? 'âŒ å·²éæœŸ' : 'âœ… æœ‰æ•ˆ'} 
                                (åˆ°æœŸ: ${expiry.toLocaleDateString()})
                            </div>
                        `;
                    }
                    
                    card.innerHTML = `
                        <h4>${info.name}</h4>
                        <div><strong>åƒ¹æ ¼:</strong> ${formatUSDT(info.price)} USDT</div>
                        <div><strong>æˆ‘çš„è¨‚é–±:</strong></div>
                        ${tokensHtml}
                    `;
                    
                    container.appendChild(card);
                }
            } catch (error) {
                showMessage('è¼‰å…¥è¨‚é–±å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function createCollection() {
            try {
                const name = document.getElementById('newServiceName').value;
                const symbol = document.getElementById('newServiceSymbol').value;
                const price = document.getElementById('newServicePrice').value;
                const duration = document.getElementById('newServiceDuration').value;
                
                if (!name || !symbol || !price || !duration) {
                    showMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½!', 'error');
                    return;
                }
                
                const priceWei = parseUSDT(price);
                const durationSeconds = duration * 24 * 60 * 60;
                
                showMessage('æ­£åœ¨å‰µå»ºæœå‹™...', 'info');
                
                const tx = await factoryContract.createSubscriptionCollection(
                    name, symbol, priceWei, durationSeconds
                );
                await tx.wait();
                
                // Clear form
                document.getElementById('newServiceName').value = '';
                document.getElementById('newServiceSymbol').value = '';
                document.getElementById('newServicePrice').value = '';
                document.getElementById('newServiceDuration').value = '';
                
                await loadCollections();
                showMessage(`æœå‹™ "${name}" å‰µå»ºæˆåŠŸ!`, 'success');
            } catch (error) {
                showMessage('å‰µå»ºæœå‹™å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('faucetBtn').addEventListener('click', getFaucet);
        document.getElementById('loadContracts').addEventListener('click', loadContracts);
        document.getElementById('loadCollections').addEventListener('click', loadCollections);
        document.getElementById('loadMySubscriptions').addEventListener('click', loadMySubscriptions);
        document.getElementById('createCollection').addEventListener('click', createCollection);

        // Auto-connect if already connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
            }
        });

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });
            
            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
    </script>
</body>
</html>
